Hystrix通过将依赖服务进行资源隔离, 进而阻止某个依赖服务出现故障时在整个系统所有的依赖服务调用中进行蔓延。同时Hystrix还提供故障时的fallback降级机制。
提升分布式系统的可用性和稳定性。

隔离手段:
    1)线程池技术:适用于依赖第三方服务, 关心timeout时间。(IO密集)
    2)信号量技术:适用于不依赖第三方服务, 只做本地复杂逻辑, 不关心超时时间。(CPU密集)

command group, 代表了某一个底层的依赖服务, 一个依赖服务可能会暴露出来多个接口, 每个接口就是一个command key。
command group在逻辑上去组织起来一堆command key的调用、统计信息、成功次数、timeout超时次数、失败次数等, 可以看到某一个服务整体的一些访问情况。
一般来说, 推荐根据一个服务区划分出一个线程池, command key默认都是属于同一个线程池的。

command key也可以单独自定义线程池使用。

fallback:
    1)断路器处于打开的状态。
    2)资源池已满(线程池 + 队列 或 信号量)。
    3)出现了任何异常的情况。
    4)超时。

Hystrix的设计原则:
    1)对依赖服务调用时出现的调用延迟和调用失败进行控制和容错保护。
    2)在复杂的分布式系统中, 阻止某一个依赖服务的故障在整个系统中蔓延。
    3)提供fail-fast(快速失败)和快速恢复的支持。
    4)提供fallback优雅降级的支持。
    5)支持近实时的监控、报警以及运维操作。

资源隔离:把对某一个依赖服务的所有调用请求, 全部隔离在同一份资源池内, 不会去用其它资源, 这就叫资源隔离。
哪怕对这个依赖服务同时发起的调用量已经到了1000, 但是线程池内就10个线程, 最多就只会用这10个线程去执行。不会因为接口调用延时, 将tomcat内部所有的线程资源全部耗尽。

execution.isolation.strategy:THREAD/SEMAPHORE。
线程池机制, 每个command运行在一个线程中, 限流是通过线程池的大小来控制的。避免无意义的超时等待。
信号量机制, 每个command运行在调用线程中, 通过信号量的容量来进行限流。

execution.isolation.semaphore.maxConcurrentRequests:使用SEMAPHORE隔离策略的时候允许访问的最大并发量, 超过这个最大并发量, 请求直接被reject。

Hystrix:资源隔离 + 限流。
    1)创建command。(创建一个调用任务)
    2)调用command执行方法。(同步或异步调用)
    3)检查是否开启缓存。(如果这个command开启了请求缓存Request Cache, 而且这个调用的结果在缓存中存在, 那么直接从缓存中返回结果。)
    4)检查是否开启了断路器。(如果断路器被打开了, 直接去执行fallback降级机制, 返回降级结果)
    5)检查线程池/队列/信号量是否已满。(如果已满, 调用fallback, 同时发送reject信息给断路器统计)
    6)执行command逻辑。(timeout或exception, 调用fallback, 同时发送reject信息给断路器统计)
    7)断路健康检查。Hystrix会把每一个依赖服务的调用成功、失败、Reject、Timeout等事件发送给circuit breaker断路器。断路器就会对这些事件的次数进行统计,
    根据异常事件发生的比例来决定是否要进行断路(熔断)。如果打开了断路器, 那么在接下来一段时间内, 会直接断路, 返回降级结果。

我们是不可能终止掉一个, 调用严重延迟的依赖服务的线程的, 只能说给你抛出来一个TimeoutException。

hystrix默认滑动窗口的时间是10秒, 默认要求滑动窗口内的请求数达到20才能触发断路器。
默认滑动窗口内故障率达到50%就会触发断路器。

断路器开启后, 再次尝试前默认睡眠5秒。5秒后断路器会变为half-open半开闭状态, 尝试让一条请求通过, 看能不能正常调用。
如果调用成功了, 那么就自动恢复, 断路器转为close状态。

Hystrix官方自己做了一个多线程异步带来的额外开销统计, 通过对比多线程异步调用 + 同步调用得出,
Netflix API每天通过Hystrix执行10亿次调用, 每个服务实例有40个以上的线程池, 每个线程池有10个左右的线程。
最后发现说, 用Hystrix的额外开销, 就是给请求带来了3ms左右的延时, 最多延时在10ms以内, 相比于可用性和稳定性的提升, 这是可以接受的。

Hystrix semaphore可以用来限流和削峰。

